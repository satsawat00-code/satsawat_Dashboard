<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LPR & ETC Matching Dashboard</title>
    
    <!-- Libraries via CDN (Pinned Versions for Stability) -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.3/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Font: Noto Sans Thai -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        /* Tighter table for ETC */
        .table-compact th, .table-compact td { padding-left: 0.5rem; padding-right: 0.5rem; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        // --- ICONS ---
        const IconActivity = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>;
        const IconCheckCircle = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>;
        const IconBarChart3 = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>;
        const IconCheck = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>;
        const IconX = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>;
        const IconUpload = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>;
        const IconFileText = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>;
        const IconFilter = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>;
        const IconInfo = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>;

        // --- UTILITIES ---
        const parseThaiDate = (dateStr) => {
            if (!dateStr || typeof dateStr !== 'string') return null;
            const parts = dateStr.split('/');
            if (parts.length !== 3) return null;
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1; 
            const yearBE = parseInt(parts[2], 10);
            const yearAD = yearBE - 543;
            return new Date(yearAD, month, day);
        };

        const parseInputDate = (dateStr) => {
            if (!dateStr) return null;
            const [y, m, d] = dateStr.split('-').map(Number);
            return new Date(y, m - 1, d);
        };

        const isWeekend = (date) => {
            const day = date.getDay();
            return day === 0 || day === 6; 
        };

        const CustomAxisTick = (props) => {
            const { x, y, payload } = props;
            const dateObj = parseThaiDate(payload.value);
            const isHoliday = dateObj ? isWeekend(dateObj) : false;
            return (
                <g transform={`translate(${x},${y})`}>
                    <text x={0} y={0} dy={16} textAnchor="middle" fill={isHoliday ? "#ef4444" : "#64748b"} fontSize={12} fontWeight={isHoliday ? "bold" : "normal"}>
                        {payload.value}
                    </text>
                </g>
            );
        };

        const getFormattedVal = (fieldElement) => {
            if (!fieldElement) return null;
            const fmtTag = fieldElement.getElementsByTagName('FormattedValue')[0];
            if (fmtTag && fmtTag.textContent !== undefined) return fmtTag.textContent.trim();
            const valTag = fieldElement.getElementsByTagName('Value')[0];
            if (valTag && valTag.textContent !== undefined) return valTag.textContent.trim();
            return null;
        };

        const parseNum = (str) => {
            if (!str) return 0;
            const cleanStr = str.replace(/,/g, '');
            const num = parseFloat(cleanStr);
            return isNaN(num) ? 0 : num;
        };

        // --- XML PARSER ---
        const parseXMLData = (xmlText, type) => {
            let cleanText = xmlText;
            const rootCloseTag = "</CrystalReport>";
            const closeIndex = cleanText.lastIndexOf(rootCloseTag);
            if (closeIndex !== -1) {
                cleanText = cleanText.substring(0, closeIndex + rootCloseTag.length);
            }
            cleanText = cleanText.replace(/xmlns="[^"]*"/g, "").replace(/xmlns:[a-zA-Z0-9]+="[^"]*"/g, "");
            cleanText = cleanText.replace(/xsi:schemaLocation\s*=\s*["'][^"']*["']/g, "");

            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(cleanText, "text/xml");
            const parserError = xmlDoc.getElementsByTagName("parsererror");
            
            if (parserError.length > 0) { 
                console.error("XML Parsing Error:", parserError[0].textContent);
                alert(`เกิดข้อผิดพลาดในการอ่านไฟล์ ${type}. กรุณาตรวจสอบรูปแบบไฟล์`);
                return []; 
            }

            const extractedData = [];
            const sections = xmlDoc.getElementsByTagName("Section");

            for (let i = 0; i < sections.length; i++) {
                const section = sections[i];
                const fields = section.getElementsByTagName("Field");
                if (fields.length === 0) continue;

                let rowRaw = {};
                let hasData = false;

                for (let j = 0; j < fields.length; j++) {
                    const field = fields[j];
                    const name = field.getAttribute("Name");
                    const value = getFormattedVal(field);
                    if (name && value !== null) { rowRaw[name] = value; hasData = true; }
                }

                if (hasData && rowRaw['date1']) { 
                    const dateObj = parseThaiDate(rowRaw['date1']);
                    if (type === 'LPR') {
                        const total = parseNum(rowRaw['total1']);
                        const auto = parseNum(rowRaw['autolpr1']);
                        const inputMatch = parseNum(rowRaw['inputlpr1']);
                        const inputPlaza = parseNum(rowRaw['inputplaza1']);
                        const pAuto = parseNum(rowRaw['percentautolpr1']); 
                        const pInputMatch = parseNum(rowRaw['percentinputlpr1']);
                        const pInputPlaza = parseNum(rowRaw['percentinputplaza1']);
                        const criteriaSum = pAuto + pInputMatch;
                        extractedData.push({
                            dateStr: rowRaw['date1'], dateObj,
                            lpr: { total, auto, pAuto, inputMatch, pInputMatch, inputPlaza, pInputPlaza, criteriaSum, passed: criteriaSum > 90.25 }
                        });
                    } else if (type === 'ETC') {
                        const total = parseNum(rowRaw['total1']);
                        const auto = parseNum(rowRaw['auto1']);
                        const inputEntry = parseNum(rowRaw['reserve1']); 
                        const autoLpr = parseNum(rowRaw['autolpr1']);
                        const inputLpr = parseNum(rowRaw['inputlpr1']);
                        const inputPlaza = parseNum(rowRaw['inputplaza1']);
                        const pAuto = parseNum(rowRaw['percentauto1']);
                        const pInputEntry = parseNum(rowRaw['percentreserve1']);
                        const pAutoLpr = parseNum(rowRaw['percentautolpr1']);
                        const pInputLpr = parseNum(rowRaw['percentinputlpr1']);
                        const pInputPlaza = parseNum(rowRaw['percentinputplaza1']);
                        const criteriaSum = pAuto + pInputEntry + pAutoLpr + pInputLpr;
                        extractedData.push({
                            dateStr: rowRaw['date1'], dateObj,
                            etc: { total, auto, pAuto, inputEntry, pInputEntry, autoLpr, pAutoLpr, inputLpr, pInputLpr, inputPlaza, pInputPlaza, criteriaSum, passed: criteriaSum > 98 }
                        });
                    } else if (type === 'EntryLPR' || type === 'ExitLPR') {
                        const total = parseNum(rowRaw['total1']);
                        const lprH = parseNum(rowRaw['lprh1']);
                        const lprHPercent = parseNum(rowRaw['lprhpercent1']);
                        const lprL = parseNum(rowRaw['lprl1']);
                        const lprLPercent = parseNum(rowRaw['lprlpercent1']);
                        
                        const passed = lprHPercent > 95;

                        const entryObj = {
                            total, lprH, lprHPercent, lprL, lprLPercent, passed
                        };

                        if(type === 'EntryLPR') {
                             extractedData.push({ dateStr: rowRaw['date1'], dateObj, entryLpr: entryObj });
                        } else {
                             extractedData.push({ dateStr: rowRaw['date1'], dateObj, exitLpr: entryObj });
                        }
                    }
                }
            }
            return extractedData;
        }

        // --- SINGLE DAY INITIAL DATA ---
        function getInitialData() {
            const day1Date = "06/01/2569";
            const day1JsDate = new Date(2026, 0, 6);
            return [{
                id: day1Date,
                date: day1Date,
                jsDate: day1JsDate,
                etc: {
                    total: 93728, auto: 89129, pAuto: 95.09,
                    inputEntry: 713, pInputEntry: 0.76,
                    autoLpr: 84, pAutoLpr: 0.09,
                    inputLpr: 3569, pInputLpr: 3.81,
                    inputPlaza: 233, pInputPlaza: 0.25,
                    criteriaSum: 99.75, passed: true
                },
                lpr: {
                    total: 127473, auto: 119257, pAuto: 93.55,
                    inputMatch: 2412, pInputMatch: 1.89,
                    inputPlaza: 5804, pInputPlaza: 4.55,
                    criteriaSum: 95.44, passed: true
                },
                entryLpr: {
                    total: 235541, lprH: 228303, lprHPercent: 96.93, lprL: 7238, lprLPercent: 3.07, passed: true
                },
                exitLpr: {
                    total: 239478, lprH: 233956, lprHPercent: 97.69, lprL: 5522, lprLPercent: 2.31, passed: true
                }
            }];
        }

        // --- COMPONENTS ---
        function StatCard({ title, value, subValue, icon: Icon, colorClass, bgClass }) {
            return (
                <div className={`p-6 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow ${bgClass || 'bg-white'}`}>
                    <div className="flex items-start justify-between">
                        <div>
                            <p className="text-sm font-medium text-slate-500 mb-1">{title}</p>
                            <h3 className="text-2xl font-bold text-slate-800">{value}</h3>
                            {subValue && <p className={`text-sm mt-2 font-medium ${colorClass}`}>{subValue}</p>}
                        </div>
                        <div className={`p-3 rounded-lg ${colorClass.replace('text-', 'bg-').replace('600', '100').replace('700', '100').replace('500','100').replace('orange', 'orange')}`}>
                            <Icon className={`w-6 h-6 ${colorClass}`} />
                        </div>
                    </div>
                </div>
            );
        }

        function StatusBadge({ passed }) {
            return (
                <span className={`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-bold ${passed ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}`}>
                    {passed ? <IconCheck className="w-3 h-3" /> : <IconX className="w-3 h-3" />}
                    {passed ? 'Pass' : 'Fail'}
                </span>
            );
        }

        function CustomRechartsTooltip({ active, payload, label }) {
            if (active && payload && payload.length) {
                return (
                    <div className="bg-white p-4 border border-slate-200 shadow-lg rounded-lg text-sm z-50">
                        <p className="font-bold text-slate-700 mb-2">{label}</p>
                        {payload.map((entry, index) => (
                            <div key={index} className="flex items-center gap-2 mb-1">
                                <div className="w-3 h-3 rounded-full" style={{ backgroundColor: entry.color }} />
                                <span className="text-slate-600">{entry.name}:</span>
                                <span className="font-semibold ml-1">
                                    {entry.name.includes('%') || entry.name.includes('Score') 
                                        ? `${Number(entry.value).toFixed(2)}%` 
                                        : Number(entry.value).toLocaleString()}
                                </span>
                            </div>
                        ))}
                    </div>
                );
            }
            return null;
        }

        function Dashboard() {
            const [activeTab, setActiveTab] = useState('overview');
            const [dateRange, setDateRange] = useState({ start: '', end: '' });
            const [data, setData] = useState([]);
            const [etcRaw, setEtcRaw] = useState(null);
            const [lprRaw, setLprRaw] = useState(null);
            const [entryLprRaw, setEntryLprRaw] = useState(null);
            const [exitLprRaw, setExitLprRaw] = useState(null);
            const [isUsingRealData, setIsUsingRealData] = useState(false);
            const [rechartsLoaded, setRechartsLoaded] = useState(false);

            useEffect(() => {
                if (window.Recharts) setRechartsLoaded(true);
                setData(getInitialData());
            }, []);

            const { 
                LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, 
                AreaChart, Area, ReferenceLine, ComposedChart, Rectangle 
            } = window.Recharts || {};

            const handleFileUpload = (event, type) => {
                const file = event.target.files[0];
                if (!file) return;
                event.target.value = ''; 
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const parsed = parseXMLData(text, type);
                        if (parsed.length === 0) return;

                        if (type === 'ETC') {
                            setEtcRaw(parsed);
                            alert(`อัปโหลด ETC สำเร็จ: พบ ${parsed.length} รายการ`);
                        }
                        if (type === 'LPR') {
                            setLprRaw(parsed);
                            alert(`อัปโหลด LPR สำเร็จ: พบ ${parsed.length} รายการ`);
                        }
                        if (type === 'EntryLPR') {
                            setEntryLprRaw(parsed);
                            alert(`อัปโหลด Entry LPR สำเร็จ: พบ ${parsed.length} รายการ`);
                        }
                        if (type === 'ExitLPR') {
                            setExitLprRaw(parsed);
                            alert(`อัปโหลด Exit LPR สำเร็จ: พบ ${parsed.length} รายการ`);
                        }
                    } catch (err) {
                        console.error(err);
                        alert("เกิดข้อผิดพลาดในการอ่านไฟล์: " + err.message);
                    }
                };
                reader.readAsText(file);
            };

            // Merge Logic
            useEffect(() => {
                if (etcRaw || lprRaw || entryLprRaw || exitLprRaw) {
                    const mergedMap = new Map();
                    const allDates = new Set();
                    if (etcRaw) etcRaw.forEach(i => allDates.add(i.dateStr));
                    if (lprRaw) lprRaw.forEach(i => allDates.add(i.dateStr));
                    if (entryLprRaw) entryLprRaw.forEach(i => allDates.add(i.dateStr));
                    if (exitLprRaw) exitLprRaw.forEach(i => allDates.add(i.dateStr));

                    allDates.forEach(dStr => mergedMap.set(dStr, { dateStr: dStr, etc: null, lpr: null, entryLpr: null, exitLpr: null }));

                    const mergeData = (rawData, key) => {
                        if (rawData) {
                            rawData.forEach(item => {
                                const existing = mergedMap.get(item.dateStr) || { dateStr: item.dateStr };
                                mergedMap.set(item.dateStr, { ...existing, [key]: item[key], jsDate: item.dateObj });
                            });
                        }
                    };

                    mergeData(etcRaw, 'etc');
                    mergeData(lprRaw, 'lpr');
                    mergeData(entryLprRaw, 'entryLpr'); // Note the key name 'entryLpr'
                    mergeData(exitLprRaw, 'exitLpr');

                    const mergedArray = Array.from(mergedMap.values())
                        .map((item, index) => ({
                            id: index,
                            date: item.dateStr,
                            jsDate: item.jsDate || parseThaiDate(item.dateStr),
                            etc: item.etc || { total: 0, auto: 0, pAuto: 0, inputEntry: 0, pInputEntry: 0, autoLpr: 0, pAutoLpr: 0, inputLpr: 0, pInputLpr: 0, inputPlaza: 0, pInputPlaza: 0, criteriaSum: 0, passed: false },
                            lpr: item.lpr || { total: 0, auto: 0, pAuto: 0, inputMatch: 0, pInputMatch: 0, inputPlaza: 0, pInputPlaza: 0, criteriaSum: 0, passed: false },
                            entryLpr: item.entryLpr || { total: 0, lprH: 0, lprHPercent: 0, lprL: 0, lprLPercent: 0, passed: false },
                            exitLpr: item.exitLpr || { total: 0, lprH: 0, lprHPercent: 0, lprL: 0, lprLPercent: 0, passed: false }
                        }))
                        .sort((a, b) => (a.jsDate && b.jsDate) ? a.jsDate - b.jsDate : 0);

                    if (mergedArray.length > 0) {
                        setData(mergedArray);
                        setIsUsingRealData(true);
                    }
                }
            }, [etcRaw, lprRaw, entryLprRaw, exitLprRaw]);

            const filteredData = useMemo(() => {
                if (!dateRange.start && !dateRange.end) return data;
                
                const start = dateRange.start ? parseInputDate(dateRange.start) : new Date(0);
                const end = dateRange.end ? parseInputDate(dateRange.end) : new Date(9999, 11, 31);
                end.setHours(23, 59, 59, 999);

                return data.filter(item => {
                    if (!item.jsDate) return false;
                    return item.jsDate >= start && item.jsDate <= end;
                });
            }, [dateRange, data]);

            const stats = useMemo(() => {
                if (filteredData.length === 0) return null;
                const totalEtc = filteredData.reduce((acc, curr) => acc + (curr.etc?.total || 0), 0);
                const totalLpr = filteredData.reduce((acc, curr) => acc + (curr.lpr?.total || 0), 0);
                
                const lprSumAuto = filteredData.reduce((acc, curr) => acc + (curr.lpr?.auto || 0), 0);
                const lprSumInputMatch = filteredData.reduce((acc, curr) => acc + (curr.lpr?.inputMatch || 0), 0);
                const lprSumInputPlaza = filteredData.reduce((acc, curr) => acc + (curr.lpr?.inputPlaza || 0), 0);
                
                const etcSumAuto = filteredData.reduce((acc, curr) => acc + (curr.etc?.auto || 0), 0);
                const etcSumInputEntry = filteredData.reduce((acc, curr) => acc + (curr.etc?.inputEntry || 0), 0);
                const etcSumAutoLpr = filteredData.reduce((acc, curr) => acc + (curr.etc?.autoLpr || 0), 0);
                const etcSumInputLpr = filteredData.reduce((acc, curr) => acc + (curr.etc?.inputLpr || 0), 0);
                const etcSumInputPlaza = filteredData.reduce((acc, curr) => acc + (curr.etc?.inputPlaza || 0), 0);

                const lprGlobalPAuto = totalLpr ? (lprSumAuto / totalLpr) * 100 : 0;
                const lprGlobalPInputMatch = totalLpr ? (lprSumInputMatch / totalLpr) * 100 : 0;
                const lprGlobalPInputPlaza = totalLpr ? (lprSumInputPlaza / totalLpr) * 100 : 0;
                const lprGlobalCriteria = lprGlobalPAuto + lprGlobalPInputMatch;

                const etcGlobalPAuto = totalEtc ? (etcSumAuto / totalEtc) * 100 : 0;
                const etcGlobalPInputEntry = totalEtc ? (etcSumInputEntry / totalEtc) * 100 : 0;
                const etcGlobalPAutoLpr = totalEtc ? (etcSumAutoLpr / totalEtc) * 100 : 0;
                const etcGlobalPInputLpr = totalEtc ? (etcSumInputLpr / totalEtc) * 100 : 0;
                const etcGlobalPInputPlaza = totalEtc ? (etcSumInputPlaza / totalEtc) * 100 : 0;
                const etcGlobalCriteria = etcGlobalPAuto + etcGlobalPInputEntry + etcGlobalPAutoLpr + etcGlobalPInputLpr;

                // Entry & Exit Stats
                const totalEntry = filteredData.reduce((acc, curr) => acc + (curr.entryLpr?.total || 0), 0);
                const totalExit = filteredData.reduce((acc, curr) => acc + (curr.exitLpr?.total || 0), 0);
                const entryH = filteredData.reduce((acc, curr) => acc + (curr.entryLpr?.lprH || 0), 0);
                const entryL = filteredData.reduce((acc, curr) => acc + (curr.entryLpr?.lprL || 0), 0);
                const exitH = filteredData.reduce((acc, curr) => acc + (curr.exitLpr?.lprH || 0), 0);
                const exitL = filteredData.reduce((acc, curr) => acc + (curr.exitLpr?.lprL || 0), 0);

                const entryHPercent = totalEntry ? (entryH / totalEntry) * 100 : 0;
                const entryLPercent = totalEntry ? (entryL / totalEntry) * 100 : 0;
                const exitHPercent = totalExit ? (exitH / totalExit) * 100 : 0;
                const exitLPercent = totalExit ? (exitL / totalExit) * 100 : 0;

                return {
                    totalEtc, totalLpr,
                    avgEtcCriteria: etcGlobalCriteria.toFixed(2),
                    avgLprCriteria: lprGlobalCriteria.toFixed(2),
                    lpr: { total: totalLpr, auto: lprSumAuto, pAuto: lprGlobalPAuto, inputMatch: lprSumInputMatch, pInputMatch: lprGlobalPInputMatch, inputPlaza: lprSumInputPlaza, pInputPlaza: lprGlobalPInputPlaza },
                    etc: { total: totalEtc, auto: etcSumAuto, pAuto: etcGlobalPAuto, inputEntry: etcSumInputEntry, pInputEntry: etcGlobalPInputEntry, autoLpr: etcSumAutoLpr, pAutoLpr: etcGlobalPAutoLpr, inputLpr: etcSumInputLpr, pInputLpr: etcGlobalPInputLpr, inputPlaza: etcSumInputPlaza, pInputPlaza: etcGlobalPInputPlaza },
                    entryLpr: { total: totalEntry, lprH: entryH, lprHPercent: entryHPercent, lprL: entryL, lprLPercent: entryLPercent },
                    exitLpr: { total: totalExit, lprH: exitH, lprHPercent: exitHPercent, lprL: exitL, lprLPercent: exitLPercent }
                };
            }, [filteredData]);

            const comparisonData = filteredData.map(d => ({ date: d.date, 'ETC Total': d.etc.total, 'LPR Total': d.lpr.total }));
            const accuracyData = filteredData.map(d => ({ date: d.date, 'Entry LPR (%)': d.entryLpr?.lprHPercent || 0, 'Exit LPR (%)': d.exitLpr?.lprHPercent || 0 }));
            const criteriaData = filteredData.map(d => ({ date: d.date, 'ETC KPI %': parseFloat(d.etc.criteriaSum.toFixed(2)), 'LPR KPI %': parseFloat(d.lpr.criteriaSum.toFixed(2)) }));

            if (!rechartsLoaded) return <div className="flex items-center justify-center min-h-screen"><div className="text-xl font-bold text-blue-600">Loading Dashboard...</div></div>;

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-900 pb-20">
                    {/* Top Bar */}
                    <div className="bg-slate-800 text-white px-6 py-3 text-sm shadow-md">
                        <div className="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
                            <div className="flex items-center gap-3">
                                <span className={`w-3 h-3 rounded-full shadow-lg ${isUsingRealData ? 'bg-green-400' : 'bg-yellow-400 animate-pulse'}`}></span>
                                <span className="font-medium tracking-wide">{isUsingRealData ? 'โหมดข้อมูลจริง (Real Data Active)' : 'โหมดข้อมูลตัวอย่าง (Sample Data - 06/01/2569)'}</span>
                            </div>
                            <div className="flex items-center gap-4 flex-wrap">
                                {/* Swapped Order: LPR First, then ETC */}
                                <label className="flex items-center gap-2 cursor-pointer bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded-md transition-all border border-slate-600 hover:border-purple-400 hover:text-purple-300">
                                    <IconUpload className="w-4 h-4 text-purple-300" />
                                    <span className="font-medium">Up. LPR</span>
                                    <input type="file" accept=".xml" onClick={(e) => (e.target.value = null)} onChange={(e) => handleFileUpload(e, 'LPR')} className="hidden" />
                                </label>
                                <label className="flex items-center gap-2 cursor-pointer bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded-md transition-all border border-slate-600 hover:border-blue-400 hover:text-blue-300">
                                    <IconUpload className="w-4 h-4 text-blue-300" />
                                    <span className="font-medium">Up. ETC</span>
                                    <input type="file" accept=".xml" onClick={(e) => (e.target.value = null)} onChange={(e) => handleFileUpload(e, 'ETC')} className="hidden" />
                                </label>
                                <label className="flex items-center gap-2 cursor-pointer bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded-md transition-all border border-slate-600 hover:border-emerald-400 hover:text-emerald-300">
                                    <IconUpload className="w-4 h-4 text-emerald-300" />
                                    <span className="font-medium">Up. Entry</span>
                                    <input type="file" accept=".xml" onClick={(e) => (e.target.value = null)} onChange={(e) => handleFileUpload(e, 'EntryLPR')} className="hidden" />
                                </label>
                                <label className="flex items-center gap-2 cursor-pointer bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded-md transition-all border border-slate-600 hover:border-pink-400 hover:text-pink-300">
                                    <IconUpload className="w-4 h-4 text-pink-300" />
                                    <span className="font-medium">Up. Exit</span>
                                    <input type="file" accept=".xml" onClick={(e) => (e.target.value = null)} onChange={(e) => handleFileUpload(e, 'ExitLPR')} className="hidden" />
                                </label>
                            </div>
                        </div>
                    </div>

                    {/* Navbar */}
                    <nav className="bg-white border-b border-slate-200 px-6 py-4 sticky top-0 z-10 shadow-sm/50 backdrop-blur-sm bg-white/90">
                        <div className="max-w-7xl mx-auto flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div className="flex items-center gap-4">
                                <div className="bg-gradient-to-br from-blue-600 to-indigo-600 p-2.5 rounded-xl shadow-lg shadow-blue-200">
                                    <IconActivity className="text-white w-6 h-6" />
                                </div>
                                <div>
                                    <h1 className="text-2xl font-bold text-slate-800 tracking-tight">Matching Dashboard</h1>
                                    <p className="text-xs font-medium text-slate-500 mt-0.5">ระบบรายงานสถิติ LPR และ ETC ประจำวัน</p>
                                </div>
                            </div>
                            <div className="flex items-center bg-slate-100/80 p-1.5 rounded-xl border border-slate-200 overflow-x-auto">
                                {['overview', 'lpr', 'etc', 'entry', 'exit'].map((tab) => (
                                    <button
                                        key={tab}
                                        onClick={() => setActiveTab(tab)}
                                        className={`px-5 py-2 text-sm font-semibold rounded-lg transition-all duration-200 whitespace-nowrap ${
                                            activeTab === tab 
                                                ? 'bg-white text-blue-600 shadow-sm ring-1 ring-black/5' 
                                                : 'text-slate-500 hover:text-slate-700 hover:bg-slate-200/50'
                                        }`}
                                    >
                                        {tab === 'overview' && 'ภาพรวม (Overview)'}
                                        {tab === 'lpr' && 'LPR Matching'}
                                        {tab === 'etc' && 'ETC Matching'}
                                        {tab === 'entry' && 'Entry LPR'}
                                        {tab === 'exit' && 'Exit LPR'}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </nav>

                    {/* Main Content */}
                    <main className="max-w-7xl mx-auto px-6 py-8">
                        
                        {!isUsingRealData && (
                            <div className="mb-8 p-4 bg-blue-50 border border-blue-200 rounded-xl flex items-start gap-3 text-blue-800">
                                <IconInfo className="w-5 h-5 mt-0.5 shrink-0" />
                                <div>
                                    <p className="font-semibold">กำลังแสดงข้อมูลตัวอย่าง (Sample Data)</p>
                                    <p className="text-sm mt-1 opacity-90">ขณะนี้ระบบแสดงผลเฉพาะข้อมูลวันที่ 06/01/2569 ที่ยืนยันความถูกต้องแล้ว <br/>กรุณากดปุ่ม Upload ด้านบนเพื่อนำเข้าข้อมูลจริงทั้งหมดเข้าสู่ระบบ</p>
                                </div>
                            </div>
                        )}

                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 mb-8 flex flex-wrap items-center gap-6">
                            <div className="flex items-center gap-2 text-slate-700 font-semibold bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100">
                                <IconFilter className="w-4 h-4 text-slate-500" />
                                <span>ตัวกรอง:</span>
                            </div>
                            <div className="flex items-center gap-3">
                                <span className="text-sm font-medium text-slate-500">จากวันที่:</span>
                                <input type="date" className="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" onChange={(e) => setDateRange(prev => ({ ...prev, start: e.target.value }))} />
                            </div>
                            <div className="flex items-center gap-3">
                                <span className="text-sm font-medium text-slate-500">ถึงวันที่:</span>
                                <input type="date" className="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" onChange={(e) => setDateRange(prev => ({ ...prev, end: e.target.value }))} />
                            </div>
                            <button onClick={() => setDateRange({ start: '', end: '' })} className="text-sm font-medium text-slate-500 hover:text-blue-600 px-3 py-1.5 rounded-lg ml-auto">ล้างค่าตัวกรอง</button>
                        </div>

                        {!stats ? (
                            <div className="flex flex-col items-center justify-center py-20 bg-white rounded-2xl border-2 border-dashed border-slate-200">
                                <IconFileText className="w-8 h-8 text-slate-400 mb-4" />
                                <p className="text-slate-600 font-medium">ไม่พบข้อมูลตามช่วงวันที่เลือก</p>
                            </div>
                        ) : (
                            <>
                                {activeTab === 'overview' && (
                                    <div className="space-y-8 animate-in fade-in duration-500">
                                        <div className="space-y-4">
                                            <div className="flex items-center gap-3"><div className="h-8 w-1 bg-purple-600 rounded-full"></div><h3 className="text-lg font-bold text-purple-700">LPR Matching Overview</h3></div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <StatCard title="Total LPR Transaction" value={stats.totalLpr.toLocaleString()} subValue="ปริมาณจราจร" icon={IconActivity} colorClass="text-blue-600" bgClass="bg-white border-purple-100" />
                                                <StatCard title="Avg LPR KPI Score" value={`${stats.avgLprCriteria}%`} subValue="Target > 90.25%" icon={IconCheckCircle} colorClass="text-blue-600" bgClass="bg-white border-purple-100" />
                                            </div>
                                        </div>
                                        <div className="space-y-4 pt-6 border-t border-slate-200">
                                            <div className="flex items-center gap-3"><div className="h-8 w-1 bg-orange-600 rounded-full"></div><h3 className="text-lg font-bold text-orange-700">ETC Matching Overview</h3></div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <StatCard title="Total ETC Transaction" value={stats.totalEtc.toLocaleString()} subValue="ปริมาณจราจร" icon={IconActivity} colorClass="text-orange-600" bgClass="bg-white border-orange-100" />
                                                {/* Corrected: Avg ETC KPI Score in Orange */}
                                                <StatCard title="Avg ETC KPI Score" value={`${stats.avgEtcCriteria}%`} subValue="Target > 98%" icon={IconCheckCircle} colorClass="text-orange-600" bgClass="bg-white border-orange-100" />
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
                                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                                <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2"><IconBarChart3 className="w-5 h-5 text-slate-400" />ปริมาณจราจร</h3>
                                                <div className="h-80"><ResponsiveContainer width="100%" height="100%"><AreaChart data={comparisonData}><defs><linearGradient id="colorEtc" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#ea580c" stopOpacity={0.1}/><stop offset="95%" stopColor="#ea580c" stopOpacity={0}/></linearGradient><linearGradient id="colorLpr" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#2563eb" stopOpacity={0.1}/><stop offset="95%" stopColor="#2563eb" stopOpacity={0}/></linearGradient></defs><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" /><XAxis dataKey="date" tick={<CustomAxisTick />} stroke="#94a3b8" tickLine={false} axisLine={false} /><YAxis tickFormatter={(value) => `${value / 1000}k`} tick={{fontSize: 12, fill: '#94a3b8'}} stroke="#94a3b8" tickLine={false} axisLine={false} /><Tooltip content={<CustomRechartsTooltip />} /><Legend /><Area type="monotone" dataKey="ETC Total" stroke="#ea580c" fillOpacity={1} fill="url(#colorEtc)" strokeWidth={2} /><Area type="monotone" dataKey="LPR Total" stroke="#2563eb" fillOpacity={1} fill="url(#colorLpr)" strokeWidth={2} /></AreaChart></ResponsiveContainer></div>
                                            </div>
                                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                                <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2"><IconActivity className="w-5 h-5 text-slate-400" />แนวโน้ม KPI</h3>
                                                <div className="h-80"><ResponsiveContainer width="100%" height="100%"><LineChart data={criteriaData}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" /><XAxis dataKey="date" tick={<CustomAxisTick />} stroke="#94a3b8" tickLine={false} axisLine={false} /><YAxis domain={[80, 100]} tick={{fontSize: 12, fill: '#94a3b8'}} stroke="#94a3b8" unit="%" tickLine={false} axisLine={false} /><Tooltip content={<CustomRechartsTooltip />} /><Legend /><ReferenceLine y={98} stroke="#ea580c" strokeDasharray="3 3" label={{ value: 'Target 98%', position: 'insideTopLeft', fill: '#ea580c', fontSize: 12 }} /><ReferenceLine y={90.25} stroke="#2563eb" strokeDasharray="3 3" label={{ value: 'Target 90.25%', position: 'insideBottomLeft', fill: '#2563eb', fontSize: 12 }} /><Line type="monotone" dataKey="ETC KPI %" stroke="#ea580c" strokeWidth={2} dot={{r: 4, strokeWidth: 2, fill: '#fff'}} /><Line type="monotone" dataKey="LPR KPI %" stroke="#2563eb" strokeWidth={2} dot={{r: 4, strokeWidth: 2, fill: '#fff'}} /></LineChart></ResponsiveContainer></div>
                                            </div>
                                        </div>

                                        {/* Entry & Exit Overview Section Below Graph */}
                                        <div className="space-y-4 pt-6 border-t border-slate-200">
                                            <div className="flex items-center gap-3"><div className="h-8 w-1 bg-teal-600 rounded-full"></div><h3 className="text-lg font-bold text-teal-700">Entry & Exit LPR Overview</h3></div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                                <StatCard title="Entry LPR Total" value={stats.entryLpr.total.toLocaleString()} subValue="ปริมาณจราจร" icon={IconActivity} colorClass="text-emerald-600" bgClass="bg-white border-emerald-100" />
                                                <StatCard title="Entry Accuracy" value={`${stats.entryLpr.lprHPercent.toFixed(2)}%`} subValue="Target > 95%" icon={IconCheckCircle} colorClass="text-emerald-600" bgClass="bg-white border-emerald-100" />
                                                <StatCard title="Exit LPR Total" value={stats.exitLpr.total.toLocaleString()} subValue="ปริมาณจราจร" icon={IconActivity} colorClass="text-pink-600" bgClass="bg-white border-pink-100" />
                                                <StatCard title="Exit Accuracy" value={`${stats.exitLpr.lprHPercent.toFixed(2)}%`} subValue="Target > 95%" icon={IconCheckCircle} colorClass="text-pink-600" bgClass="bg-white border-pink-100" />
                                            </div>
                                        </div>

                                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mt-6">
                                            <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2"><IconActivity className="w-5 h-5 text-teal-500" />Entry & Exit LPR Accuracy</h3>
                                            <div className="h-80"><ResponsiveContainer width="100%" height="100%"><LineChart data={accuracyData}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" /><XAxis dataKey="date" tick={<CustomAxisTick />} stroke="#94a3b8" tickLine={false} axisLine={false} /><YAxis domain={[90, 100]} tick={{fontSize: 12, fill: '#94a3b8'}} stroke="#94a3b8" unit="%" tickLine={false} axisLine={false} /><Tooltip content={<CustomRechartsTooltip />} /><Legend /><ReferenceLine y={95} stroke="#10b981" strokeDasharray="3 3" label={{ value: 'Target 95%', position: 'right', fill: '#10b981', fontSize: 12 }} /><Line type="monotone" dataKey="Entry LPR (%)" stroke="#10b981" strokeWidth={2} dot={{r: 4, strokeWidth: 2, fill: '#fff'}} /><Line type="monotone" dataKey="Exit LPR (%)" stroke="#f43f5e" strokeWidth={2} dot={{r: 4, strokeWidth: 2, fill: '#fff'}} /></LineChart></ResponsiveContainer></div>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'lpr' && (
                                    <div className="space-y-6 animate-in fade-in duration-500">
                                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                            <div className="flex justify-between mb-8"><h3 className="text-lg font-bold text-slate-800 flex items-center gap-2"><IconActivity className="w-5 h-5 text-purple-600" />LPR Performance</h3></div>
                                            <div className="h-96"><ResponsiveContainer width="100%" height="100%"><ComposedChart data={filteredData}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" /><XAxis dataKey="date" tick={<CustomAxisTick />} stroke="#94a3b8" tickLine={false} axisLine={false} /><YAxis yAxisId="left" orientation="left" domain={[85, 100]} unit="%" stroke="#7c3aed" fontSize={12} tickLine={false} axisLine={false} /><YAxis yAxisId="right" orientation="right" stroke="#cbd5e1" tickFormatter={(val) => `${val/1000}k`} fontSize={12} tickLine={false} axisLine={false} /><Tooltip content={<CustomRechartsTooltip />} /><Bar yAxisId="right" dataKey="lpr.total" name="Traffic Volume" barSize={32} fill="#a78bfa" fillOpacity={0.25} radius={[6, 6, 0, 0]} /><ReferenceLine yAxisId="left" y={90.25} stroke="#ef4444" strokeDasharray="3 3" label={{ value: 'Target 90.25%', position: 'insideTopRight', fill: '#ef4444', fontSize: 12 }} /><Line yAxisId="left" type="monotone" dataKey="lpr.criteriaSum" name="LPR KPI Score" stroke="#7c3aed" strokeWidth={3} dot={{r: 4, fill: '#7c3aed', strokeWidth: 2, stroke: '#fff'}} /></ComposedChart></ResponsiveContainer></div>
                                        </div>
                                        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                            <div className="p-5 bg-white border-b border-slate-100 flex items-center gap-2"><IconFileText className="w-5 h-5 text-purple-600" /><h3 className="font-bold text-slate-800">ตารางข้อมูล LPR Matching</h3></div>
                                            <div className="overflow-x-auto custom-scrollbar"><table className="w-full text-xs md:text-sm text-left whitespace-nowrap"><thead className="bg-slate-50 text-slate-600 font-semibold border-b border-slate-200 uppercase tracking-wider text-[11px]"><tr><th className="px-5 py-4">วันที่</th><th className="px-5 py-4 text-right">Total</th><th className="px-5 py-4 bg-purple-50/50 text-purple-900 text-right">Auto Match</th><th className="px-5 py-4 bg-purple-50/50 text-purple-900 text-right">% Auto</th><th className="px-5 py-4 bg-teal-50/50 text-teal-900 text-right">%Input</th><th className="px-5 py-4 bg-teal-50/50 text-teal-900 text-right">Input%</th><th className="px-5 py-4 bg-amber-50/50 text-amber-900 text-right">Input Plaza</th><th className="px-5 py-4 bg-amber-50/50 text-amber-900 text-right">%Plaza</th><th className="px-5 py-4 text-center">KPI Score (%)</th><th className="px-5 py-4 text-center">Status</th></tr></thead><tbody className="divide-y divide-slate-100">{filteredData.map((row) => (<tr key={row.id} className="hover:bg-slate-50"><td className="px-5 py-3.5 font-medium text-slate-700">{row.date}</td><td className="px-5 py-3.5 text-right font-mono text-slate-600">{row.lpr.total.toLocaleString()}</td><td className="px-5 py-3.5 bg-purple-50/30 text-right font-mono text-purple-700">{row.lpr.auto.toLocaleString()}</td><td className="px-5 py-3.5 bg-purple-50/30 text-right text-purple-700 font-semibold">{row.lpr.pAuto.toFixed(2)}%</td><td className="px-5 py-3.5 bg-teal-50/30 text-right font-mono text-teal-700">{row.lpr.inputMatch.toLocaleString()}</td><td className="px-5 py-3.5 bg-teal-50/30 text-right text-teal-700">{row.lpr.pInputMatch.toFixed(2)}%</td><td className="px-5 py-3.5 bg-amber-50/30 text-right font-mono text-amber-700">{row.lpr.inputPlaza.toLocaleString()}</td><td className="px-5 py-3.5 bg-amber-50/30 text-right text-amber-700">{row.lpr.pInputPlaza.toFixed(2)}%</td><td className="px-5 py-3.5 text-center"><span className={`px-2.5 py-0.5 rounded-full font-bold ${row.lpr.criteriaSum > 90.25 ? 'bg-purple-100 text-purple-700' : 'bg-red-100 text-red-700'}`}>{row.lpr.criteriaSum.toFixed(2)}%</span></td><td className="px-5 py-3.5 text-center"><StatusBadge passed={row.lpr.passed} /></td></tr>))}
                                            <tr className="bg-slate-100 font-bold border-t-2 border-slate-300"><td className="px-5 py-4 text-slate-800">รวม / เฉลี่ย</td><td className="px-5 py-4 text-right font-mono">{stats.lpr.total.toLocaleString()}</td><td className="px-5 py-4 bg-purple-200/50 text-right font-mono text-purple-900">{stats.lpr.auto.toLocaleString()}</td><td className="px-5 py-4 bg-purple-200/50 text-right text-purple-900">{stats.lpr.pAuto.toFixed(2)}%</td><td className="px-5 py-4 bg-teal-200/50 text-right font-mono text-teal-900">{stats.lpr.inputMatch.toLocaleString()}</td><td className="px-5 py-4 bg-teal-200/50 text-right text-teal-900">{stats.lpr.pInputMatch.toFixed(2)}%</td><td className="px-5 py-4 bg-amber-200/50 text-right font-mono text-amber-900">{stats.lpr.inputPlaza.toLocaleString()}</td><td className="px-5 py-4 bg-amber-200/50 text-right text-amber-900">{stats.lpr.pInputPlaza.toFixed(2)}%</td><td className="px-5 py-4 text-center text-slate-800">{stats.avgLprCriteria}%</td><td className="px-5 py-4 text-center text-xs text-slate-400">AVG</td></tr>
                                            </tbody></table></div>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'etc' && (
                                    <div className="space-y-6 animate-in fade-in duration-500">
                                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                            <div className="flex justify-between mb-8"><h3 className="text-lg font-bold text-slate-800 flex items-center gap-2"><IconActivity className="w-5 h-5 text-orange-600" />ETC Performance</h3></div>
                                            <div className="h-96"><ResponsiveContainer width="100%" height="100%"><ComposedChart data={filteredData}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" /><XAxis dataKey="date" tick={<CustomAxisTick />} stroke="#94a3b8" tickLine={false} axisLine={false} /><YAxis yAxisId="left" orientation="left" domain={[94, 100]} unit="%" stroke="#ea580c" fontSize={12} tickLine={false} axisLine={false} /><YAxis yAxisId="right" orientation="right" stroke="#cbd5e1" tickFormatter={(val) => `${val/1000}k`} fontSize={12} tickLine={false} axisLine={false} /><Tooltip content={<CustomRechartsTooltip />} /><Bar yAxisId="right" dataKey="etc.total" name="Traffic Volume" barSize={32} fill="#fdba74" fillOpacity={0.25} radius={[6, 6, 0, 0]} /><ReferenceLine yAxisId="left" y={98} stroke="#ef4444" strokeDasharray="3 3" label={{ value: 'Target 98%', position: 'insideTopRight', fill: '#ef4444', fontSize: 12 }} /><Line yAxisId="left" type="monotone" dataKey="etc.criteriaSum" name="ETC KPI Score" stroke="#ea580c" strokeWidth={3} dot={{r: 4, fill: '#ea580c', strokeWidth: 2, stroke: '#fff'}} /></ComposedChart></ResponsiveContainer></div>
                                        </div>
                                        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                            <div className="p-5 bg-white border-b border-slate-100 flex items-center gap-2"><IconFileText className="w-5 h-5 text-orange-600" /><h3 className="font-bold text-slate-800">ตารางข้อมูล ETC Matching</h3></div>
                                            {/* ETC Table optimized for fit without scroll */}
                                            <div className="overflow-x-auto custom-scrollbar">
                                                <table className="w-full text-[10px] md:text-xs text-left whitespace-nowrap table-compact">
                                                    <thead className="bg-slate-50 text-slate-600 font-semibold border-b border-slate-200 uppercase tracking-wider">
                                                        <tr>
                                                            <th className="py-3">วันที่</th>
                                                            <th className="py-3 text-right">Total</th>
                                                            <th className="py-3 bg-blue-50/50 text-blue-900 text-right">Auto</th>
                                                            <th className="py-3 bg-blue-50/50 text-blue-900 text-right">%Auto</th>
                                                            <th className="py-3 bg-emerald-50/50 text-emerald-900 text-right">In.Ent</th>
                                                            <th className="py-3 bg-emerald-50/50 text-emerald-900 text-right">%In</th>
                                                            <th className="py-3 bg-orange-50/50 text-orange-900 text-right">A.LPR</th>
                                                            <th className="py-3 bg-orange-50/50 text-orange-900 text-right">%A.LPR</th>
                                                            <th className="py-3 bg-indigo-50/50 text-indigo-900 text-right">In.LPR</th>
                                                            <th className="py-3 bg-indigo-50/50 text-indigo-900 text-right">%In.LPR</th>
                                                            <th className="py-3 bg-gray-50 text-gray-700 text-right">In.Plz</th>
                                                            <th className="py-3 bg-gray-50 text-gray-700 text-right">%Plz</th>
                                                            <th className="py-3 text-center">KPI(%)</th>
                                                            <th className="py-3 text-center">Status</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-slate-100">
                                                        {filteredData.map((row) => (
                                                            <tr key={row.id} className="hover:bg-slate-50">
                                                                <td className="py-2 font-medium text-slate-700">{row.date}</td>
                                                                <td className="py-2 text-right font-mono text-slate-600">{row.etc.total.toLocaleString()}</td>
                                                                <td className="py-2 bg-blue-50/30 text-right font-mono text-blue-700">{row.etc.auto.toLocaleString()}</td>
                                                                <td className="py-2 bg-blue-50/30 text-right text-blue-700 font-semibold">{row.etc.pAuto.toFixed(2)}%</td>
                                                                <td className="py-2 bg-emerald-50/30 text-right font-mono text-emerald-700">{row.etc.inputEntry.toLocaleString()}</td>
                                                                <td className="py-2 bg-emerald-50/30 text-right text-emerald-700">{row.etc.pInputEntry.toFixed(2)}%</td>
                                                                <td className="py-2 bg-orange-50/30 text-right font-mono text-orange-700">{row.etc.autoLpr.toLocaleString()}</td>
                                                                <td className="py-2 bg-orange-50/30 text-right text-orange-700">{row.etc.pAutoLpr.toFixed(2)}%</td>
                                                                <td className="py-2 bg-indigo-50/30 text-right font-mono text-indigo-700">{row.etc.inputLpr.toLocaleString()}</td>
                                                                <td className="py-2 bg-indigo-50/30 text-right text-indigo-700">{row.etc.pInputLpr.toFixed(2)}%</td>
                                                                <td className="py-2 bg-gray-50/50 text-right font-mono text-gray-600">{row.etc.inputPlaza.toLocaleString()}</td>
                                                                <td className="py-2 bg-gray-50/50 text-right text-gray-600">{row.etc.pInputPlaza.toFixed(2)}%</td>
                                                                <td className="py-2 text-center">
                                                                    <span className={`px-1.5 py-0.5 rounded font-bold ${row.etc.criteriaSum > 98 ? 'bg-blue-100 text-blue-700' : 'bg-red-100 text-red-700'}`}>
                                                                        {row.etc.criteriaSum.toFixed(2)}%
                                                                    </span>
                                                                </td>
                                                                <td className="py-2 text-center"><StatusBadge passed={row.etc.passed} /></td>
                                                            </tr>
                                                        ))}
                                                        <tr className="bg-slate-100 font-bold border-t-2 border-slate-300">
                                                            <td className="py-2 text-slate-800">Total</td>
                                                            <td className="py-2 text-right font-mono">{stats.etc.total.toLocaleString()}</td>
                                                            <td className="py-2 bg-blue-200/50 text-right font-mono text-blue-900">{stats.etc.auto.toLocaleString()}</td>
                                                            <td className="py-2 bg-blue-200/50 text-right text-blue-900">{stats.etc.pAuto.toFixed(2)}%</td>
                                                            <td className="py-2 bg-emerald-200/50 text-right font-mono text-emerald-900">{stats.etc.inputEntry.toLocaleString()}</td>
                                                            <td className="py-2 bg-emerald-200/50 text-right text-emerald-900">{stats.etc.pInputEntry.toFixed(2)}%</td>
                                                            <td className="py-2 bg-orange-200/50 text-right font-mono text-orange-900">{stats.etc.autoLpr.toLocaleString()}</td>
                                                            <td className="py-2 bg-orange-200/50 text-right text-orange-900">{stats.etc.pAutoLpr.toFixed(2)}%</td>
                                                            <td className="py-2 bg-indigo-200/50 text-right font-mono text-indigo-900">{stats.etc.inputLpr.toLocaleString()}</td>
                                                            <td className="py-2 bg-indigo-200/50 text-right text-indigo-900">{stats.etc.pInputLpr.toFixed(2)}%</td>
                                                            <td className="py-2 bg-gray-200/50 text-right font-mono text-gray-800">{stats.etc.inputPlaza.toLocaleString()}</td>
                                                            <td className="py-2 bg-gray-200/50 text-right text-gray-800">{stats.etc.pInputPlaza.toFixed(2)}%</td>
                                                            <td className="py-2 text-center text-slate-800">{stats.avgEtcCriteria}%</td>
                                                            <td className="py-2 text-center text-xs text-slate-400">AVG</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {['entry', 'exit'].map(type => (
                                    activeTab === type && (
                                        <div key={type} className="space-y-6 animate-in fade-in duration-500">
                                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                                <div className="flex justify-between mb-8">
                                                    <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                                        <IconActivity className={`w-5 h-5 ${type === 'entry' ? 'text-emerald-600' : 'text-pink-600'}`} />
                                                        {type === 'entry' ? 'Entry LPR Accuracy' : 'Exit LPR Accuracy'}
                                                    </h3>
                                                </div>
                                                <div className="h-96">
                                                    <ResponsiveContainer width="100%" height="100%">
                                                        <ComposedChart data={filteredData}>
                                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                                            <XAxis dataKey="date" tick={<CustomAxisTick />} stroke="#94a3b8" tickLine={false} axisLine={false} />
                                                            <YAxis yAxisId="left" orientation="left" domain={[80, 100]} unit="%" stroke={type === 'entry' ? '#059669' : '#e11d48'} fontSize={12} tickLine={false} axisLine={false} />
                                                            <YAxis yAxisId="right" orientation="right" stroke="#cbd5e1" tickFormatter={(val) => `${val/1000}k`} fontSize={12} tickLine={false} axisLine={false} />
                                                            <Tooltip content={<CustomRechartsTooltip />} />
                                                            <Bar yAxisId="right" dataKey={`${type}Lpr.total`} name="Total Volume" barSize={32} fill={type === 'entry' ? '#a7f3d0' : '#fecdd3'} fillOpacity={0.4} radius={[6, 6, 0, 0]} />
                                                            <ReferenceLine yAxisId="left" y={95} stroke="#ef4444" strokeDasharray="3 3" label={{ value: 'Target 95%', position: 'insideTopRight', fill: '#ef4444', fontSize: 12 }} />
                                                            <Line yAxisId="left" type="monotone" dataKey={`${type}Lpr.lprHPercent`} name="% LPR > 95%" stroke={type === 'entry' ? '#059669' : '#e11d48'} strokeWidth={3} dot={{r: 4, fill: '#7c3aed', strokeWidth: 2, stroke: '#fff'}} />
                                                        </ComposedChart>
                                                    </ResponsiveContainer>
                                                </div>
                                            </div>

                                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                                <div className="p-5 bg-white border-b border-slate-100 flex items-center gap-2">
                                                    <IconFileText className={`w-5 h-5 ${type === 'entry' ? 'text-emerald-600' : 'text-pink-600'}`} />
                                                    <h3 className="font-bold text-slate-800">{type === 'entry' ? 'Entry LPR Data' : 'Exit LPR Data'}</h3>
                                                </div>
                                                <div className="overflow-x-auto custom-scrollbar">
                                                    <table className="w-full text-xs md:text-sm text-left whitespace-nowrap">
                                                        <thead className="bg-slate-50 text-slate-600 font-semibold border-b border-slate-200 uppercase tracking-wider">
                                                            <tr>
                                                                <th className="px-6 py-4">วันที่</th>
                                                                <th className="px-6 py-4 text-right">Total</th>
                                                                {/* Corrected Exit LPR Header Colors */}
                                                                <th className={`px-6 py-4 text-right ${type === 'entry' ? 'bg-emerald-50 text-emerald-900' : 'bg-emerald-50 text-emerald-900'}`}>LPR &gt; 95%</th>
                                                                <th className={`px-6 py-4 text-right ${type === 'entry' ? 'bg-emerald-50 text-emerald-900' : 'bg-emerald-50 text-emerald-900'}`}>%</th>
                                                                {/* Corrected Entry/Exit LPR < 95% Header Colors to Red */}
                                                                <th className="px-6 py-4 text-right text-rose-900 bg-rose-50">LPR &lt; 95%</th>
                                                                <th className="px-6 py-4 text-right text-rose-900 bg-rose-50">%</th>
                                                                <th className="px-6 py-4 text-center">Status</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody className="divide-y divide-slate-100">
                                                            {filteredData.map((row) => {
                                                                const item = row[`${type}Lpr`];
                                                                if (!item) return null; 

                                                                return (
                                                                    <tr key={row.id} className="hover:bg-slate-50">
                                                                        <td className="px-6 py-3.5 font-medium text-slate-700">{row.date}</td>
                                                                        <td className="px-6 py-3.5 text-right font-mono text-slate-600">{(item.total || 0).toLocaleString()}</td>
                                                                        {/* Corrected Exit LPR Data Colors */}
                                                                        <td className={`px-6 py-3.5 text-right font-mono ${type === 'entry' ? 'bg-emerald-50/30 text-emerald-700' : 'bg-emerald-50/30 text-emerald-700'}`}>{(item.lprH || 0).toLocaleString()}</td>
                                                                        <td className={`px-6 py-3.5 text-right font-bold ${type === 'entry' ? 'bg-emerald-50/30 text-emerald-700' : 'bg-emerald-50/30 text-emerald-700'}`}>{(item.lprHPercent || 0).toFixed(2)}%</td>
                                                                        {/* Corrected Entry/Exit LPR < 95% Data Colors to Red */}
                                                                        <td className="px-6 py-3.5 text-right font-mono text-rose-700 bg-rose-50/30">{(item.lprL || 0).toLocaleString()}</td>
                                                                        <td className="px-6 py-3.5 text-right font-bold text-rose-700 bg-rose-50/30">{(item.lprLPercent || 0).toFixed(2)}%</td>
                                                                        <td className="px-6 py-3.5 text-center"><StatusBadge passed={item.passed} /></td>
                                                                    </tr>
                                                                );
                                                            })}
                                                            <tr className="bg-slate-100 font-bold border-t-2 border-slate-300">
                                                                <td className="px-6 py-4 text-slate-800">รวม / เฉลี่ย</td>
                                                                <td className="px-6 py-4 text-right font-mono">{(stats[`${type}Lpr`]?.total || 0).toLocaleString()}</td>
                                                                {/* Corrected Summary Row Colors */}
                                                                <td className={`px-6 py-4 text-right font-mono ${type === 'entry' ? 'bg-emerald-100 text-emerald-900' : 'bg-emerald-100 text-emerald-900'}`}>{(stats[`${type}Lpr`]?.lprH || 0).toLocaleString()}</td>
                                                                <td className={`px-6 py-4 text-right font-bold ${type === 'entry' ? 'bg-emerald-100 text-emerald-900' : 'bg-emerald-100 text-emerald-900'}`}>{(stats[`${type}Lpr`]?.lprHPercent || 0).toFixed(2)}%</td>
                                                                <td className="px-6 py-4 text-right font-mono text-rose-900 bg-rose-100">{(stats[`${type}Lpr`]?.lprL || 0).toLocaleString()}</td>
                                                                <td className="px-6 py-4 text-right font-bold text-rose-900 bg-rose-100">{(stats[`${type}Lpr`]?.lprLPercent || 0).toFixed(2)}%</td>
                                                                <td className="px-6 py-4 text-center text-xs text-slate-400">AVG</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    )
                                ))}
                            </>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>